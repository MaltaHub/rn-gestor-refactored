[
  {
    "routine_name": "rpc_gerenciar_caracteristicas",
    "return_type": "jsonb",
    "routine_definition": "\ndeclare\n  v_id uuid;\nbegin\n  if p_operacao = 'criar' then\n    insert into caracteristicas (empresa_id, nome)\n    values (p_empresa_id, p_dados->>'nome')\n    returning id into v_id;\n\n    return jsonb_build_object('sucesso', true, 'id', v_id);\n\n  elsif p_operacao = 'atualizar' then\n    update caracteristicas\n      set nome = coalesce(p_dados->>'nome', nome)\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'apagar' then\n    delete from caracteristicas\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'listar' then\n    return (\n      select jsonb_agg(c.*)\n      from caracteristicas c\n      where empresa_id = p_empresa_id\n    );\n  else\n    return jsonb_build_object('sucesso', false, 'erro', 'Operação inválida');\n  end if;\nend;\n"
  },
  {
    "routine_name": "rpc_gerenciar_locais",
    "return_type": "jsonb",
    "routine_definition": "\ndeclare\n  v_id uuid;\nbegin\n  if p_operacao = 'criar' then\n    insert into locais (empresa_id, nome)\n    values (p_empresa_id, p_dados->>'nome')\n    returning id into v_id;\n\n    return jsonb_build_object('sucesso', true, 'id', v_id);\n\n  elsif p_operacao = 'atualizar' then\n    update locais\n      set nome = coalesce(p_dados->>'nome', nome)\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'apagar' then\n    delete from locais\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'listar' then\n    return (\n      select jsonb_agg(l.*)\n      from locais l\n      where empresa_id = p_empresa_id\n    );\n  else\n    return jsonb_build_object('sucesso', false, 'erro', 'Operação inválida');\n  end if;\nend;\n"
  },
  {
    "routine_name": "rpc_gerenciar_lojas",
    "return_type": "jsonb",
    "routine_definition": "\ndeclare\n  v_id uuid;\nbegin\n  if p_operacao = 'criar' then\n    insert into lojas (empresa_id, nome)\n    values (p_empresa_id, p_dados->>'nome')\n    returning id into v_id;\n\n    return jsonb_build_object('sucesso', true, 'id', v_id);\n\n  elsif p_operacao = 'atualizar' then\n    update lojas\n      set nome = coalesce(p_dados->>'nome', nome)\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'apagar' then\n    delete from lojas\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'listar' then\n    return (\n      select jsonb_agg(l.*)\n      from lojas l\n      where empresa_id = p_empresa_id\n    );\n  else\n    return jsonb_build_object('sucesso', false, 'erro', 'Operação inválida');\n  end if;\nend;\n"
  },
  {
    "routine_name": "rpc_gerenciar_modelos",
    "return_type": "json",
    "routine_definition": "\ndeclare\n  v_id uuid;\n  v_uid uuid := auth.uid();\n  v_resp json;\n  v_log jsonb;\nbegin\n  -- Monta JSON de log com todos os parâmetros\n  v_log := jsonb_build_object(\n    'empresa_id', p_empresa_id,\n    'operacao',   p_operacao,\n    'id_alvo',    p_id_alvo,\n    'dados',      p_dados\n  );\n\n  if p_operacao = 'criar' then\n    insert into modelos (\n      empresa_id, marca, nome, edicao, carroceria, combustivel, tipo_cambio,\n      motor, cambio, cilindros, valvulas, lugares, portas, cabine, tracao,\n      ano_inicial, ano_final, criado_em\n    )\n    values (\n      p_empresa_id,\n      p_dados->>'marca',\n      p_dados->>'nome',\n      p_dados->>'edicao',\n      (p_dados->>'carroceria')::tipo_carroceria,\n      (p_dados->>'combustivel')::tipo_combustivel,\n      (p_dados->>'tipo_cambio')::tipo_cambio,\n      p_dados->>'motor',\n      p_dados->>'cambio',\n      nullif(p_dados->>'cilindros','')::int,\n      nullif(p_dados->>'valvulas','')::int,\n      nullif(p_dados->>'lugares','')::int,\n      nullif(p_dados->>'portas','')::int,\n      p_dados->>'cabine',\n      p_dados->>'tracao',\n      nullif(p_dados->>'ano_inicial','')::int,\n      nullif(p_dados->>'ano_final','')::int,\n      now()\n    )\n    returning id into v_id;\n\n    v_resp := json_build_object('sucesso', true, 'id', v_id);\n\n    insert into waiter.log_modelos(empresa_id, usuario_id, operacao, modelo_id, dados)\n    values (p_empresa_id, v_uid, 'criar', v_id, v_log);\n\n  elsif p_operacao = 'atualizar' then\n    update modelos\n       set marca = coalesce(p_dados->>'marca', marca),\n           nome  = coalesce(p_dados->>'nome', nome),\n           atualizado_em = now()\n     where id = p_id_alvo\n       and empresa_id = p_empresa_id;\n\n    v_resp := json_build_object('sucesso', true, 'id', p_id_alvo);\n\n    insert into waiter.log_modelos(empresa_id, usuario_id, operacao, modelo_id, dados)\n    values (p_empresa_id, v_uid, 'atualizar', p_id_alvo, v_log);\n\n  elsif p_operacao = 'apagar' then\n    delete from modelos\n     where id = p_id_alvo\n       and empresa_id = p_empresa_id;\n\n    v_resp := json_build_object('sucesso', true, 'id', p_id_alvo);\n\n    insert into waiter.log_modelos(empresa_id, usuario_id, operacao, modelo_id, dados)\n    values (p_empresa_id, v_uid, 'apagar', p_id_alvo, v_log);\n\n  elsif p_operacao = 'listar' then\n    v_resp := (\n      select coalesce(json_agg(to_json(m)), '[]'::json)\n      from modelos m\n      where empresa_id = p_empresa_id\n    );\n\n    insert into waiter.log_modelos(empresa_id, usuario_id, operacao, dados)\n    values (p_empresa_id, v_uid, 'listar', v_log);\n\n  else\n    v_resp := json_build_object('sucesso', false, 'erro', 'Operação inválida');\n\n    insert into waiter.log_modelos(empresa_id, usuario_id, operacao, dados)\n    values (p_empresa_id, v_uid, 'invalido', v_log);\n  end if;\n\n  return v_resp;\nend;\n"
  },
  {
    "routine_name": "rpc_gerenciar_plataformas",
    "return_type": "jsonb",
    "routine_definition": "\ndeclare\n  v_id uuid;\nbegin\n  if p_operacao = 'criar' then\n    insert into plataformas (empresa_id, nome)\n    values (p_empresa_id, p_dados->>'nome')\n    returning id into v_id;\n\n    return jsonb_build_object('sucesso', true, 'id', v_id);\n\n  elsif p_operacao = 'atualizar' then\n    update plataformas\n      set nome = coalesce(p_dados->>'nome', nome)\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'apagar' then\n    delete from plataformas\n      where id = p_id_alvo and empresa_id = p_empresa_id;\n\n    return jsonb_build_object('sucesso', true, 'id', p_id_alvo);\n\n  elsif p_operacao = 'listar' then\n    return (\n      select jsonb_agg(p.*)\n      from plataformas p\n      where empresa_id = p_empresa_id\n    );\n  else\n    return jsonb_build_object('sucesso', false, 'erro', 'Operação inválida');\n  end if;\nend;\n"
  }
]